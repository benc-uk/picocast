pico-8 cartridge // http://www.pico-8.com
version 36
__lua__
px = 2
py = 2
fx = 1
fy = 0.0
bsize = 8

function _update()
  local dir = 0
  if (btn(0)) then dir=0.01 end
  if (btn(1)) then dir=-0.01 end

  if (dir == 0) then
    return
  end
 
  r = rotate(fx, fy, dir)
  fx = r[1]
  fy = r[2]
  -- cs = cos(dir);
  -- sn = sin(dir);

  -- fxn = fx * cs - fy * sn; 
  -- fyn = fx * sn + fy * cs;
  -- fx = fxn;
  -- fy = fyn;
end

function rotate(x, y, angle)
  cs = cos(angle);
  sn = sin(angle);
  local r = {}
  r.x = x * cs - y * sn;
  r.y = x * sn + y * cs;
  return r
  --return x * cs - y * sn, x * sn + y * cs;
end

function _draw()
  cls(0)
  for x=0,127 do
    for y=0, 63 do
      m = mget(x,y)
      if (m > 0) then   
        draw_square(x*bsize, y*bsize, bsize, m)
      end
    end
  end

  --draw_square(px*bsize, py*bsize, bsize, 8)
  cast_ray(px, py, fx, fy, 0.1, 5)
end

function cast_ray(px, py, dx, dy, step, dist)

  local t = 0
  while t < dist do
    t = t + step
    local x = px + dx * t
    local y = py + dy * t

    if mget(x, y) != 0 then
      return mget(x, y)
    else
      pset(x*bsize, y*bsize, 7)
    end
  end
end


function draw_square(x, y, w, c)
  for i=x,x+w-1 do
    for j=y,y+w-1 do
      pset(i, j, c)
    end
  end
end
__gfx__
00000000111111112222222233333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111112222222233333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700111111112222222233333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000111111112222222233333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000111111112222222233333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700111111112222222233333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111112222222233333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111112222222233333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000008000000000000080008000080000800000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000800000000000808808000080008000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000080000000000800088000800008000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000080000000000800008888000080000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000008800000008000080000000800000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000088000008000080000008000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000880008000800008880000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000008888888888880000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000008008000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000008880000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000000000100010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000001000001000000000100010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000001000000000001000100010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000010001000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000010000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000101010101000001000000000100010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000001000100000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000101010100010101000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000001010000010000010100000100010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000001010000000000010100000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
